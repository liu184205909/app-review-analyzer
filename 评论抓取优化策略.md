# ğŸ“ˆ è¯„è®ºæŠ“å–ä¼˜åŒ–ç­–ç•¥

> å¦‚ä½•åœ¨ä¿æŒé€Ÿåº¦çš„å‰æä¸‹å¤§å¹…å¢åŠ è¯„è®ºæ•°é‡

---

## ğŸ¯ å½“å‰çŠ¶æ€

### âœ… MVP ç‰ˆæœ¬ï¼ˆå·²å®ç°ï¼‰
- **iOS**: 2 é¡µ (~100 æ¡è¯„è®º)
- **Android**: 150 æ¡è¯„è®º
- **å®Œæˆæ—¶é—´**: 3-7 ç§’
- **ä¼˜åŠ¿**: å¿«é€Ÿå“åº”ï¼Œä½æˆæœ¬
- **é™åˆ¶**: Vercel Serverless 10 ç§’è¶…æ—¶

---

## ğŸš€ ä¼˜åŒ–è·¯çº¿å›¾

### Phase 1: åˆ†ç¦»å¼æŠ“å–ï¼ˆæ¨èä¼˜å…ˆå®ç°ï¼‰

#### ğŸ“Š ç­–ç•¥ï¼šå¿«é€Ÿå“åº” + åå°å¢é‡

```
ç”¨æˆ·è¯·æ±‚
  â†“
ç«‹å³åˆ›å»ºä»»åŠ¡ï¼ˆ0.5ç§’ï¼‰
  â†“
å¿«é€ŸæŠ“å– 50-100 æ¡è¯„è®ºï¼ˆ2-3ç§’ï¼‰
  â†“
è¿”å›åˆæ­¥åˆ†æç»“æœ â† ç”¨æˆ·çœ‹åˆ°ç»“æœäº†ï¼
  â†“
åå°ç»§ç»­æŠ“å– 500-1000 æ¡ï¼ˆå¼‚æ­¥ï¼‰
  â†“
å¢é‡æ›´æ–°åˆ†æ â† å‰ç«¯è‡ªåŠ¨åˆ·æ–°
```

#### ğŸ› ï¸ æŠ€æœ¯å®ç°

**1. ä¿®æ”¹ API æµç¨‹**

```typescript
// app/api/analyze/route.ts
export async function POST(request: NextRequest) {
  // Phase 1: å¿«é€Ÿå“åº”ï¼ˆ< 3ç§’ï¼‰
  const quickReviews = await fetchQuickReviews(appId, 50);
  const quickAnalysis = await analyzeReviews(quickReviews);
  
  await prisma.analysisTask.update({
    where: { id: taskId },
    data: {
      status: 'partial',  // æ–°å¢çŠ¶æ€
      progress: 50,
      result: quickAnalysis,
    },
  });

  // Phase 2: åå°å¢é‡ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡å“åº”ï¼‰
  queueIncrementalFetch(taskId, appId, {
    targetCount: 1000,
    currentCount: 50,
  });

  return NextResponse.json({
    taskId,
    status: 'partial',
    message: 'Initial analysis complete, fetching more reviews...',
  });
}
```

**2. å¢é‡æŠ“å–é˜Ÿåˆ—**

```typescript
// lib/queue/incremental-fetch.ts
export async function queueIncrementalFetch(
  taskId: string,
  appId: string,
  options: { targetCount: number; currentCount: number }
) {
  // é€‰é¡¹ A: ä½¿ç”¨ Vercel Cron Jobsï¼ˆç®€å•ï¼Œå…è´¹ï¼‰
  // é€‰é¡¹ B: ä½¿ç”¨ Upstash QStashï¼ˆå¼ºå¤§ï¼Œæœ‰å…è´¹é¢åº¦ï¼‰
  // é€‰é¡¹ C: ä½¿ç”¨ BullMQ + Redisï¼ˆè‡ªå»ºï¼Œå®Œå…¨æ§åˆ¶ï¼‰
  
  // åˆ†æ‰¹æ¬¡æŠ“å–ï¼Œé¿å…è¶…æ—¶
  const batchSize = 100;
  const batches = Math.ceil(
    (options.targetCount - options.currentCount) / batchSize
  );

  for (let i = 0; i < batches; i++) {
    await fetchBatch(appId, i * batchSize, batchSize);
    await updateAnalysis(taskId);
    
    // æ›´æ–°è¿›åº¦
    const progress = 50 + (i + 1) / batches * 50;
    await updateProgress(taskId, progress);
  }
}
```

**3. å‰ç«¯è‡ªåŠ¨åˆ·æ–°**

```typescript
// app/analysis/[slug]/page.tsx
useEffect(() => {
  if (task.status === 'partial') {
    // æ¯ 3 ç§’åˆ·æ–°ä¸€æ¬¡
    const interval = setInterval(async () => {
      const updated = await fetch(`/api/analyze?taskId=${taskId}`);
      setTask(updated);
      
      if (updated.status === 'completed') {
        clearInterval(interval);
      }
    }, 3000);

    return () => clearInterval(interval);
  }
}, [task.status]);
```

#### ğŸ“Š é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | Phase 1ï¼ˆå¿«é€Ÿï¼‰ | Phase 2ï¼ˆå®Œæ•´ï¼‰ |
|------|----------------|----------------|
| **è¯„è®ºæ•°** | 50-100 æ¡ | 500-1000 æ¡ |
| **å“åº”æ—¶é—´** | 2-3 ç§’ | 30-60 ç§’ |
| **ç”¨æˆ·ä½“éªŒ** | ç«‹å³çœ‹åˆ°åˆæ­¥ç»“æœ | è‡ªåŠ¨æ›´æ–°ä¸ºå®Œæ•´åˆ†æ |
| **å‡†ç¡®æ€§** | 85-90% | 95-98% |

---

### Phase 2: å¤–éƒ¨é˜Ÿåˆ—æœåŠ¡ï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰

#### ğŸ¯ é€‚ç”¨åœºæ™¯
- éœ€è¦æŠ“å– 1000+ æ¡è¯„è®º
- éœ€è¦å¯é çš„é‡è¯•æœºåˆ¶
- éœ€è¦å¤„ç†å¤šä¸ªä»»åŠ¡å¹¶å‘

#### ğŸ› ï¸ æ¨èå·¥å…·

##### é€‰é¡¹ 1: Upstash QStashï¼ˆæ¨èï¼‰

**ä¼˜åŠ¿ï¼š**
- âœ… ä¸“ä¸º Vercel ä¼˜åŒ–
- âœ… å…è´¹é¢åº¦ï¼š10,000 æ¬¡/æœˆ
- âœ… è‡ªåŠ¨é‡è¯•
- âœ… å»¶è¿Ÿ/å®šæ—¶ä»»åŠ¡
- âœ… è¿›åº¦è·Ÿè¸ª

**å®‰è£…ï¼š**
```bash
npm install @upstash/qstash
```

**ç¤ºä¾‹ä»£ç ï¼š**

```typescript
// lib/queue/qstash.ts
import { Client } from '@upstash/qstash';

const qstash = new Client({
  token: process.env.QSTASH_TOKEN!,
});

export async function enqueueReviewFetch(
  taskId: string,
  appId: string,
  options: any
) {
  await qstash.publishJSON({
    url: `${process.env.NEXT_PUBLIC_APP_URL}/api/queue/fetch-reviews`,
    body: {
      taskId,
      appId,
      options,
    },
    retries: 3,
  });
}
```

```typescript
// app/api/queue/fetch-reviews/route.ts
import { verifySignature } from '@upstash/qstash/nextjs';

async function handler(request: NextRequest) {
  const { taskId, appId, options } = await request.json();

  // æŠ“å–è¯„è®ºï¼ˆæ²¡æœ‰ 10 ç§’é™åˆ¶ï¼ï¼‰
  const reviews = await fetchReviewsInBatches(appId, {
    targetCount: 1000,
    batchSize: 100,
  });

  // åˆ†æ
  const analysis = await analyzeReviews(reviews);

  // æ›´æ–°æ•°æ®åº“
  await prisma.analysisTask.update({
    where: { id: taskId },
    data: {
      status: 'completed',
      progress: 100,
      result: analysis,
    },
  });

  return NextResponse.json({ success: true });
}

// QStash ç­¾åéªŒè¯
export const POST = verifySignature(handler);
```

**è´¹ç”¨ä¼°ç®—ï¼š**
- å…è´¹é¢åº¦ï¼š10,000 æ¬¡/æœˆ
- ä»˜è´¹ï¼š$0.50 / 1,000 æ¬¡
- **æˆæœ¬æä½ï¼**

---

##### é€‰é¡¹ 2: Inngestï¼ˆå¼€å‘è€…å‹å¥½ï¼‰

**ä¼˜åŠ¿ï¼š**
- âœ… ä¸“ä¸º Next.js è®¾è®¡
- âœ… å¯è§†åŒ–è°ƒè¯•å·¥å…·
- âœ… å…è´¹é¢åº¦ï¼š1,000 æ¬¡/æœˆ
- âœ… è‡ªåŠ¨é‡è¯•å’Œé”™è¯¯å¤„ç†

**å®‰è£…ï¼š**
```bash
npm install inngest
```

**ç¤ºä¾‹ä»£ç ï¼š**

```typescript
// inngest/client.ts
import { Inngest } from 'inngest';

export const inngest = new Inngest({ 
  id: 'app-review-analyzer' 
});
```

```typescript
// inngest/functions.ts
import { inngest } from './client';

export const fetchReviews = inngest.createFunction(
  { id: 'fetch-reviews' },
  { event: 'review/fetch.requested' },
  async ({ event, step }) => {
    // Step 1: æŠ“å–è¯„è®ºï¼ˆè‡ªåŠ¨é‡è¯•ï¼‰
    const reviews = await step.run('fetch-reviews', async () => {
      return await fetchReviewsInBatches(event.data.appId, {
        targetCount: 1000,
      });
    });

    // Step 2: AI åˆ†æ
    const analysis = await step.run('analyze-reviews', async () => {
      return await analyzeReviews(reviews);
    });

    // Step 3: ä¿å­˜ç»“æœ
    await step.run('save-result', async () => {
      await prisma.analysisTask.update({
        where: { id: event.data.taskId },
        data: {
          status: 'completed',
          result: analysis,
        },
      });
    });
  }
);
```

```typescript
// app/api/inngest/route.ts
import { serve } from 'inngest/next';
import { inngest } from '@/inngest/client';
import { fetchReviews } from '@/inngest/functions';

export const { GET, POST, PUT } = serve({
  client: inngest,
  functions: [fetchReviews],
});
```

**è§¦å‘ä»»åŠ¡ï¼š**

```typescript
// app/api/analyze/route.ts
import { inngest } from '@/inngest/client';

await inngest.send({
  name: 'review/fetch.requested',
  data: {
    taskId: task.id,
    appId,
    options,
  },
});
```

---

##### é€‰é¡¹ 3: BullMQ + Redisï¼ˆè‡ªå»ºï¼‰

**ä¼˜åŠ¿ï¼š**
- âœ… å®Œå…¨æ§åˆ¶
- âœ… é«˜æ€§èƒ½
- âœ… ä¸°å¯Œçš„åŠŸèƒ½ï¼ˆä¼˜å…ˆçº§ã€å»¶è¿Ÿç­‰ï¼‰

**ç¼ºç‚¹ï¼š**
- âš ï¸ éœ€è¦ç»´æŠ¤ Redis å®ä¾‹
- âš ï¸ é¢å¤–æˆæœ¬ï¼ˆUpstash Redis: $0.2/GBï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- éœ€è¦æé«˜è‡ªå®šä¹‰
- å·²æœ‰ Redis åŸºç¡€è®¾æ–½

---

### Phase 3: æ™ºèƒ½é‡‡æ ·ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

#### ğŸ¯ æ ¸å¿ƒæ€æƒ³
> ä¸æ˜¯æ‰€æœ‰è¯„è®ºéƒ½å€¼å¾—è¯¦ç»†åˆ†æ

#### ğŸ“Š åˆ†å±‚é‡‡æ ·ç­–ç•¥

```typescript
interface SamplingStrategy {
  // ä¼˜å…ˆçº§ 1: æœ€è¿‘çš„å·®è¯„ï¼ˆæœ€æœ‰ä»·å€¼ï¼‰
  recent_negative: {
    rating: [1, 2, 3],
    days: 30,
    count: 200,
  },

  // ä¼˜å…ˆçº§ 2: é•¿æ–‡æœ¬è¯„è®ºï¼ˆä¿¡æ¯é‡å¤§ï¼‰
  long_reviews: {
    min_length: 100,
    count: 100,
  },

  // ä¼˜å…ˆçº§ 3: é«˜èµè¯„è®ºï¼ˆæœ‰ä»£è¡¨æ€§ï¼‰
  helpful_reviews: {
    min_helpful: 10,
    count: 50,
  },

  // ä¼˜å…ˆçº§ 4: éšæœºé‡‡æ ·ï¼ˆä¿è¯å¤šæ ·æ€§ï¼‰
  random_sample: {
    count: 150,
  },
}
```

**æ€»è®¡ï¼š500 æ¡è¯„è®ºï¼Œä½†è´¨é‡æ›´é«˜ï¼**

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | è¯„è®ºæ•° | å“åº”æ—¶é—´ | å®Œæ•´åˆ†ææ—¶é—´ | å¼€å‘éš¾åº¦ | æˆæœ¬ |
|------|--------|----------|-------------|----------|------|
| **å½“å‰ MVP** | 100-150 | 3-7 ç§’ | 3-7 ç§’ | âœ… ç®€å• | å…è´¹ |
| **Phase 1: åˆ†ç¦»å¼** | 500-1000 | 2-3 ç§’ | 30-60 ç§’ | â­â­ ä¸­ç­‰ | å…è´¹ |
| **Phase 2A: QStash** | 1000+ | 2-3 ç§’ | 1-2 åˆ†é’Ÿ | â­â­ ä¸­ç­‰ | ~$5/æœˆ |
| **Phase 2B: Inngest** | 1000+ | 2-3 ç§’ | 1-2 åˆ†é’Ÿ | â­â­ ä¸­ç­‰ | ~$10/æœˆ |
| **Phase 2C: BullMQ** | æ— é™ | 2-3 ç§’ | å¯è°ƒ | â­â­â­ å¤æ‚ | ~$20/æœˆ |
| **Phase 3: æ™ºèƒ½é‡‡æ ·** | 500ï¼ˆé«˜è´¨é‡ï¼‰ | 3-5 ç§’ | 3-5 ç§’ | â­â­â­ å¤æ‚ | å…è´¹ |

---

## ğŸ¯ æ¨èè·¯å¾„

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
âœ… **å®ç° Phase 1: åˆ†ç¦»å¼æŠ“å–**
- æœ€å°æ”¹åŠ¨
- å…è´¹
- ç”¨æˆ·ä½“éªŒæå‡æ˜æ˜¾

### ä¸­æœŸï¼ˆ3-4 å‘¨ï¼‰
âœ… **é›†æˆ Upstash QStash**
- å¯é æ€§å¤§å¹…æå‡
- æ”¯æŒ 1000+ è¯„è®º
- æˆæœ¬å¯æ§

### é•¿æœŸï¼ˆ2-3 æœˆï¼‰
âœ… **å®ç°æ™ºèƒ½é‡‡æ ·**
- æé«˜åˆ†æè´¨é‡
- é™ä½æˆæœ¬
- æ›´å¿«çš„å“åº”

---

## ğŸ’» ç«‹å³å¼€å§‹

### Step 1: ä¿®æ”¹æ•°æ®åº“ Schema

```prisma
model AnalysisTask {
  // ... ç°æœ‰å­—æ®µ ...
  
  status      TaskStatus @default(pending)
  isIncremental Boolean   @default(false)  // æ–°å¢ï¼šæ˜¯å¦å¢é‡æŠ“å–
  reviewCount   Int       @default(0)      // æ–°å¢ï¼šå·²æŠ“å–è¯„è®ºæ•°
  targetCount   Int?                       // æ–°å¢ï¼šç›®æ ‡è¯„è®ºæ•°
}

enum TaskStatus {
  pending
  processing
  partial      // æ–°å¢ï¼šéƒ¨åˆ†å®Œæˆ
  completed
  failed
}
```

### Step 2: å®ç°å¿«é€ŸæŠ“å–

```typescript
// lib/scrapers/quick-fetch.ts
export async function fetchQuickReviews(
  appId: string,
  platform: 'ios' | 'android',
  count: number = 50
) {
  if (platform === 'ios') {
    return await fetchAppStoreReviews(appId, 'us', 'mostRecent', 1);
  } else {
    return await fetchGooglePlayReviews(appId, { num: count });
  }
}
```

### Step 3: ä¿®æ”¹ API

å‚è€ƒä¸Šé¢çš„ Phase 1 ä»£ç ç¤ºä¾‹

### Step 4: æµ‹è¯•

```bash
# å¿«é€Ÿå“åº”æµ‹è¯•
curl -X POST https://your-app.vercel.app/api/analyze \
  -H "Content-Type: application/json" \
  -d '{"appUrl": "instagram", "platform": "ios"}'

# åº”è¯¥åœ¨ 3 ç§’å†…è¿”å› partial çŠ¶æ€
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### ç›®æ ‡ KPI

| æŒ‡æ ‡ | å½“å‰ | Phase 1 | Phase 2 |
|------|------|---------|---------|
| **é¦–æ¬¡å“åº”** | 3-7 ç§’ | 2-3 ç§’ | 2-3 ç§’ |
| **è¯„è®ºæ•°** | 100-150 | 500-1000 | 1000+ |
| **å‡†ç¡®æ€§** | 85-90% | 90-95% | 95-98% |
| **æˆåŠŸç‡** | 95% | 98% | 99.5% |
| **æˆæœ¬/åˆ†æ** | $0.001 | $0.002 | $0.005 |

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. é€Ÿç‡é™åˆ¶
- **App Store RSS Feed**: æ— æ˜ç¡®é™åˆ¶ï¼Œä½†å»ºè®® < 10 req/s
- **Google Play Scraper**: å»ºè®®æ·»åŠ  500ms å»¶è¿Ÿ

### 2. æ•°æ®ä¸€è‡´æ€§
- å¢é‡æŠ“å–æ—¶æ³¨æ„å¤„ç†é‡å¤è¯„è®º
- ä½¿ç”¨ `reviewId` å»é‡

### 3. ç”¨æˆ·ä½“éªŒ
- æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·"æ­£åœ¨è·å–æ›´å¤šè¯„è®º"
- æ˜¾ç¤ºå®æ—¶è¿›åº¦
- æä¾›"åˆ·æ–°"æŒ‰é’®

### 4. æˆæœ¬æ§åˆ¶
- ç›‘æ§ API è°ƒç”¨æ¬¡æ•°
- è®¾ç½®å•ç”¨æˆ·è¯·æ±‚é¢‘ç‡é™åˆ¶
- è€ƒè™‘ç¼“å­˜çƒ­é—¨åº”ç”¨

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- **åŠŸèƒ½è§„åˆ’**: [åŠŸèƒ½è§„åˆ’.md](./åŠŸèƒ½è§„åˆ’.md)
- **æŠ€æœ¯æ¶æ„**: [æŠ€æœ¯è¯´æ˜.md](./æŠ€æœ¯è¯´æ˜.md)
- **å¼€å‘æŒ‡å—**: [å¼€å‘æŒ‡å—.md](./å¼€å‘æŒ‡å—.md)

---

**æ›´æ–°æ—¥æœŸ**: 2025-11-05
**ç‰ˆæœ¬**: v1.0

