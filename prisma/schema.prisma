// Prisma schema for App Review Analyzer

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 应用表（支持双平台）
model App {
  id            Int       @id @default(autoincrement())
  platform      Platform  // 'ios' | 'android'
  appId         String    // App Store ID or Package Name
  name          String?
  bundleId      String?
  iconUrl       String?
  rating        Float?
  reviewCount   Int?
  developer     String?
  category      String?
  lastCrawledAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  reviews       Review[]
  taskApps      TaskApp[]

  @@unique([platform, appId])
  @@index([platform, appId])
}

enum Platform {
  ios
  android
}

// 评论表
model Review {
  id           Int       @id @default(autoincrement())
  appId        Int
  app          App       @relation(fields: [appId], references: [id], onDelete: Cascade)
  
  platform     Platform
  reviewId     String    // Platform's original review ID
  author       String?
  rating       Int       // 1-5
  title        String?
  content      String
  reviewDate   DateTime
  appVersion   String?
  helpfulCount Int       @default(0)
  language     String?   // Language code
  country      String?   // Country code
  
  sentiment    String?   // AI-detected sentiment
  aiTags       Json?     // AI-generated tags
  
  createdAt    DateTime  @default(now())

  @@unique([platform, reviewId])
  @@index([appId, rating])
  @@index([reviewDate])
}

// 用户表
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified Boolean   @default(false)
  name          String?
  avatar        String?

  // 认证相关
  passwordHash  String?   // For email/password login
  googleId      String?   // Google OAuth ID
  appleId       String?   // Apple Sign In ID

  // 订阅相关
  subscriptionTier  SubscriptionTier @default(free)
  subscriptionId     String?  // Stripe subscription ID
  subscriptionEnds   DateTime? // Subscription end date

  // 使用量限制
  monthlyAnalysisCount Int @default(0)
  lastResetDate       DateTime @default(now()) // Last time monthly count was reset

  // 偏好设置
  preferredLanguage String @default("en")
  timezone         String?

  // 邮件通知设置
  emailNotifications Boolean @default(true)  // Overall email notifications toggle
  analysisCompletedNotifications Boolean @default(true)  // Analysis completion notifications
  marketingEmails Boolean @default(false)  // Marketing/promotional emails
  securityNotifications Boolean @default(true)  // Security-related notifications

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  analysisTasks    AnalysisTask[]
  usageLogs        UsageLog[]
  subscriptions   Subscription[]
}

enum SubscriptionTier {
  free        // 免费用户：每月 3 次分析
  professional // 专业用户：$29/月，无限分析
  team        // 团队用户：$99/月，多用户协作 + 高级功能
}

// 订阅记录表
model Subscription {
  id              String            @id @default(uuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe 相关
  stripeCustomerId String?          // Stripe customer ID
  stripeSubscriptionId String?       // Stripe subscription ID
  stripePriceId     String?          // Stripe price ID

  // 订阅信息
  tier            SubscriptionTier
  status          SubscriptionStatus @default(active)
  price           Float             // 订阅价格
  currency        String @default("usd")

  // 周期信息
  interval        SubscriptionInterval @default(month) // month | year
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // 取消信息
  cancelAtPeriodEnd Boolean @default(false)
  canceledAt       DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([stripeSubscriptionId])
}

enum SubscriptionStatus {
  active     // 活跃订阅
  canceled   // 已取消（仍在使用期内）
  past_due   // 逾期
  incomplete // 未完成
  trialing   // 试用中
  unpaid     // 未支付
}

enum SubscriptionInterval {
  month
  year
}

// 使用记录表
model UsageLog {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 使用类型
  actionType    UsageAction

  // 关联的分析任务（可选）
  taskId        String?

  // 元数据
  metadata      Json?       // 额外的使用信息

  createdAt     DateTime    @default(now())

  @@index([userId, actionType])
  @@index([createdAt])
  @@index([taskId])
}

enum UsageAction {
  analysis_started    // 开始分析
  analysis_completed  // 完成分析
  analysis_failed     // 分析失败
  login                // 用户登录
  signup              // 用户注册
  subscription_upgraded // 订阅升级
  subscription_downgraded // 订阅降级
}

// 分析任务表（扩展原有模型）
model AnalysisTask {
  id          String    @id @default(uuid())
  userId      String?   // User ID (now required for tracking)
  taskType    TaskType  // 'single' | 'comparison'
  status      TaskStatus @default(pending)
  progress    Int       @default(0)

  // App identification (for single app analysis)
  platform    Platform? // App platform
  appStoreId  String?   // App Store ID or Package Name

  // SEO-friendly URL slug (e.g., "instagram-ios", "tiktok-android")
  appSlug     String?
  isLatest    Boolean   @default(true) // Mark as latest analysis for this app

  modelUsed   String?   // AI model identifier
  options     Json?     // Analysis options
  result      Json?     // Analysis result
  errorMsg    String?

  // 成本和使用量跟踪
  reviewCount   Int?   // 处理的评论数量
  tokensUsed    Int?   // 使用的AI tokens
  cost          Float? // 分析成本

  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  user        User?       @relation(fields: [userId], references: [id])
  taskApps    TaskApp[]

  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([appSlug, isLatest])
  @@index([platform, appStoreId, createdAt])  // For finding latest analysis
}

enum TaskType {
  single
  comparison
}

enum TaskStatus {
  pending
  processing
  partial      // 新增：部分完成，继续后台抓取
  completed
  failed
}

// 任务关联应用表（支持竞品对比）
model TaskApp {
  id      Int          @id @default(autoincrement())
  taskId  String
  task    AnalysisTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  appId   Int
  app     App          @relation(fields: [appId], references: [id])
  
  role    AppRole      // 'target' | 'competitor'
  
  createdAt DateTime   @default(now())

  @@index([taskId])
}

enum AppRole {
  target
  competitor
}

// AI模型配置表
model AIModel {
  id              Int      @id @default(autoincrement())
  modelKey        String   @unique
  provider        String   // 'openrouter', 'anthropic-direct', etc.
  displayName     String
  apiModelName    String   // Actual model name for API calls
  
  costInput       Float    // Cost per 1K tokens (input)
  costOutput      Float    // Cost per 1K tokens (output)
  maxTokens       Int?
  
  capabilities    Json     // {"languages": ["en","zh"], "speed": "fast"}
  isActive        Boolean  @default(true)
  priority        Int      @default(0)
  
  planRestrictions String[] // ['free', 'pro', 'enterprise']
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 访客分析记录表（追踪未登录用户的使用）
model GuestAnalysis {
  id            String    @id @default(uuid())
  
  // 访客标识（IP地址 + User-Agent fingerprint）
  ipAddress     String
  fingerprint   String?   // Browser fingerprint for additional tracking
  
  // 分析任务引用
  taskId        String?   // Reference to AnalysisTask if created
  
  // 元数据
  platform      Platform?
  appUrl        String?
  userAgent     String?
  
  createdAt     DateTime  @default(now())
  expiresAt     DateTime  // 24小时后过期，允许重新分析
  
  @@index([ipAddress, createdAt])
  @@index([fingerprint, createdAt])
  @@index([expiresAt])
}

