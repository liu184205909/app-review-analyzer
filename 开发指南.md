# 📗 App Review Analyzer - 开发指南

> 完整的开发文档：安装、配置、测试、问题解决

---

## 📋 目录

1. [环境准备](#环境准备)
2. [项目安装](#项目安装)
3. [环境配置](#环境配置)
4. [数据库配置](#数据库配置)
5. [启动项目](#启动项目)
6. [项目结构](#项目结构)
7. [测试指南](#测试指南)
8. [常见问题](#常见问题)
9. [Google Play 访问问题](#google-play-访问问题)
10. [部署到生产环境](#部署到生产环境)

---

## 环境准备

### 必需工具

| 工具 | 版本要求 | 用途 | 获取方式 |
|------|---------|------|---------|
| **Node.js** | 18.17+ | 运行环境 | https://nodejs.org/ |
| **npm** | 9.0+ | 包管理器 | 随 Node.js 安装 |
| **Git** | 最新版 | 版本控制 | https://git-scm.com/ |
| **VS Code** | 最新版 | 代码编辑器（推荐） | https://code.visualstudio.com/ |

### 检查环境

```bash
# 检查 Node.js 版本
node --version  # 应该 >= v18.17.0

# 检查 npm 版本
npm --version   # 应该 >= 9.0.0
```

### 外部服务

| 服务 | 用途 | 费用 | 注册链接 |
|------|------|------|---------|
| **Supabase** | PostgreSQL 数据库 | 免费（500MB） | https://supabase.com |
| **OpenRouter** | AI 模型 API | $5起步 | https://openrouter.ai |

---

## 项目安装

### 步骤 1: 克隆项目

```bash
# 如果从 Git 仓库克隆
git clone <your-repo-url>
cd app-review-analyzer

# 如果已经有项目文件夹
cd app-review-analyzer
```

### 步骤 2: 安装依赖包

**⚠️ 中国大陆用户必读：** npm 默认源很慢，建议切换到国内镜像

```bash
# 🇨🇳 中国大陆用户：切换到国内镜像（永久生效）
npm config set registry https://registry.npmmirror.com

# 验证镜像源
npm config get registry
# 应该显示：https://registry.npmmirror.com/

# 清除缓存
npm cache clean --force

# 安装依赖（需要 2-5 分钟）
npm install
```

**常见错误处理：**

```bash
# 如果遇到 "network error" 或 "ETIMEDOUT"
npm config set registry https://registry.npmmirror.com
npm cache clean --force
npm install

# 如果遇到 "permission denied"
# Windows: 以管理员身份运行 PowerShell
# Mac/Linux: sudo npm install
```

---

## 环境配置

### 步骤 1: 创建环境变量文件

```bash
# 复制示例文件
cp .env.example .env.local

# 或者手动创建（Windows）
New-Item -Path .env.local -ItemType File
```

### 步骤 2: 配置 Supabase 数据库

#### 2.1 注册 Supabase

1. 访问 https://supabase.com
2. 点击 "Start your project"
3. 使用 GitHub 登录（推荐）

#### 2.2 创建项目

1. 点击 "New Project"
2. 填写信息：
   - **Name**: `app-review-analyzer`
   - **Database Password**: 设置密码（**只用字母和数字，不要特殊字符**）
     - ✅ 推荐：`Liu184205909`
     - ❌ 避免：`P@ssw0rd!#`（特殊字符会导致URL编码问题）
   - **Region**: 选择距离最近的（如 Singapore）
3. 点击 "Create new project"（等待 2-3 分钟）

#### 2.3 获取数据库连接串

1. 项目创建完成后，点击左侧 **Settings**
2. 点击 **Database**
3. 找到 **Connection string** 区域
4. 选择 **Session mode** （重要！）
   - ⚠️ **不要选** Transaction mode（Prisma 不兼容）
5. 复制连接串，格式如下：
   ```
   postgresql://postgres.xxx:[YOUR-PASSWORD]@xxx.pooler.supabase.com:5432/postgres?pgbouncer=true
   ```
6. 将 `[YOUR-PASSWORD]` 替换为你的实际密码

#### 2.4 填入 .env.local

编辑 `d:\Project code\app-review-analyzer\.env.local`：

```bash
# Supabase 数据库连接（Session Pooler）
DATABASE_URL="postgresql://postgres.xxx:Liu184205909@xxx.pooler.supabase.com:5432/postgres?pgbouncer=true"
```

### 步骤 3: 配置 OpenRouter API Key

#### 3.1 注册 OpenRouter

1. 访问 https://openrouter.ai
2. 点击右上角 "Sign In"
3. 使用 GitHub 或 Google 登录

#### 3.2 获取 API Key

1. 登录后，点击右上角头像
2. 选择 "API Keys"
3. 点击 "Create Key"
4. 复制 API Key（格式：`sk-or-v1-xxx...`）

#### 3.3 充值（可选）

- 最低充值 $5
- 测试阶段建议先充 $5-10
- 每次分析约 $0.01-0.05

#### 3.4 填入 .env.local

```bash
# OpenRouter AI 模型 API Key
OPENROUTER_API_KEY="sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
```

### 最终的 .env.local 示例

```bash
# Supabase Database (Session Pooler)
DATABASE_URL="postgresql://postgres.abcdefghijk:Liu184205909@aws-0-ap-southeast-1.pooler.supabase.com:5432/postgres?pgbouncer=true"

# OpenRouter API Key
OPENROUTER_API_KEY="sk-or-v1-1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
```

---

## 数据库配置

### 步骤 1: 推送数据库 Schema

```bash
# 初始化数据库表结构
npx prisma db push
```

**预期输出：**
```
Environment variables loaded from .env.local
Prisma schema loaded from prisma\schema.prisma
Datasource "db": PostgreSQL database "postgres"

🚀  Your database is now in sync with your Prisma schema. Done in 2.34s
```

**常见错误：**

#### 错误 1: `Environment variable not found: DATABASE_URL`

**原因：** `.env.local` 文件不存在或路径错误

**解决：**
```bash
# 检查文件是否存在
ls .env.local  # Mac/Linux
dir .env.local # Windows

# 如果不存在，重新创建
cp .env.example .env.local
# 然后编辑填入正确的 DATABASE_URL
```

#### 错误 2: `P1000: Authentication failed`

**原因：** 密码包含特殊字符或密码错误

**解决：**
1. 去 Supabase → Settings → Database
2. 点击 "Reset database password"
3. 设置新密码（**只用字母和数字**），如：`Liu184205909`
4. 更新 `.env.local` 中的 `DATABASE_URL`

#### 错误 3: `Schema engine error: unexpected message from server`

**原因：** 使用了 Transaction mode 而不是 Session mode

**解决：**
1. 去 Supabase → Settings → Database
2. 在 Connection string 区域，选择 **Session mode**
3. 复制新的连接串（包含 `?pgbouncer=true`）
4. 更新 `.env.local`

### 步骤 2: 生成 Prisma Client

```bash
# 生成 Prisma 客户端代码
npx prisma generate
```

**预期输出：**
```
✔ Generated Prisma Client (5.8.0) to ./node_modules/@prisma/client in 234ms
```

---

## 启动项目

### 步骤 1: 启动开发服务器

```bash
# 启动服务器（前台运行）
npm run dev
```

**预期输出：**
```
   ▲ Next.js 14.x.x
   - Local:        http://localhost:3000
   - Network:      http://192.168.x.x:3000

 ✓ Ready in 3.2s
```

### 步骤 2: 打开浏览器

访问 **http://localhost:3000**

你应该看到项目首页！🎉

---

## 项目结构

### 📁 目录结构

```
app-review-analyzer/
├── prisma/
│   └── schema.prisma          # 数据库模型定义
├── src/
│   ├── app/
│   │   ├── api/
│   │   │   └── analyze/
│   │   │       └── route.ts   # 分析 API 端点
│   │   ├── analysis/
│   │   │   └── [slug]/
│   │   │       └── page.tsx   # 分析结果页面
│   │   ├── page.tsx           # 首页
│   │   └── layout.tsx         # 布局
│   ├── components/
│   │   └── ReviewList.tsx     # 评论列表组件
│   └── lib/
│       ├── ai/
│       │   └── openrouter.ts  # AI 分析服务
│       ├── scrapers/
│       │   ├── app-store.ts   # iOS 评论抓取
│       │   └── google-play.ts # Android 评论抓取
│       ├── prisma.ts          # 数据库客户端
│       └── slug.ts            # URL 生成工具
├── .env                       # 环境变量
└── package.json               # 项目配置
```

### 🔑 核心文件说明

#### 1. 数据库模型 (`prisma/schema.prisma`)
- 定义数据结构：App, Review, AnalysisTask
- 支持 iOS 和 Android 双平台

#### 2. API 路由 (`src/app/api/analyze/route.ts`)
- **POST**: 创建新的分析任务
- **GET**: 查询分析结果
- 后台处理评论抓取和 AI 分析

#### 3. 评论抓取器 (`src/lib/scrapers/`)
- `app-store.ts`: 使用 Apple RSS Feed API
- `google-play.ts`: 使用 google-play-scraper 包

#### 4. AI 服务 (`src/lib/ai/openrouter.ts`)
- 集成 OpenRouter API
- 支持多种 AI 模型（Claude, GPT-4, DeepSeek）

### 🔄 数据流程

```
用户输入 URL
  ↓
API 提取 App ID
  ↓
后台抓取评论
  ↓
存储到数据库
  ↓
发送给 AI 分析
  ↓
保存分析结果
  ↓
前端展示报告
```

### 📦 主要依赖

| 包名 | 用途 |
|------|------|
| `next` | React 框架 |
| `@prisma/client` | 数据库 ORM |
| `openai` | OpenRouter API 客户端 |
| `google-play-scraper` | Android 评论抓取 |
| `tailwindcss` | CSS 框架 |

> 💡 更多技术细节请查看 [功能规划.md](./功能规划.md)

---

## 测试指南

### 🧪 测试 1: Instagram (iOS)

**推荐：先测试 iOS，验证系统正常**

#### 步骤

1. 打开 http://localhost:3000
2. 确保平台选择 **iOS App Store**
3. 输入 Instagram URL：
   ```
   https://apps.apple.com/us/app/instagram/id389801252
   ```
4. 勾选 **Focus on negative reviews**（推荐）
5. 点击 **Start Analysis** 🔍

#### 预期结果

- ⏳ 跳转到分析页面（约 30-60 秒）
- 📊 URL 变为：`http://localhost:3000/analysis/instagram-ios`
- ✅ 显示分析结果：
  - 情感分析（正面/中性/负面比例）
  - 关键问题（Critical Issues）
  - 体验问题（Experience Issues）
  - 功能请求（Feature Requests）
  - 优先行动建议
  - 典型用户评论（可筛选：All/Positive/Negative）

#### 验证要点

- ✅ URL 是简洁格式（`instagram-ios`，不包含 App ID）
- ✅ 评论筛选功能正常（All/Positive/Negative）
- ✅ 分页功能正常（每页 10 条）
- ✅ 数据显示完整

---

### 🧪 测试 2: TikTok (Android)

**⚠️ 注意：** Android 测试在中国大陆可能失败（Google Play 被封锁）

#### 步骤

1. 平台选择 **Google Play**
2. 输入 TikTok URL：
   ```
   https://play.google.com/store/apps/details?id=com.zhiliaoapp.musically
   ```
3. 点击 **Start Analysis**

#### 可能的结果

##### 成功（如果有 VPN 或在海外）

- ✅ URL: `/analysis/tiktok-android`
- ✅ 正常显示分析结果

##### 失败（中国大陆，无 VPN）

- ❌ 错误：`Error: App not found`
- 📝 查看终端日志：
  ```
  [Google Play] Fetching app info for: com.zhiliaoapp.musically
  ❌ [Google Play] Error details: { error: 'ETIMEDOUT', ... }
  ```

**解决方案：** 查看 [Google Play 访问问题](#google-play-访问问题)

---

### 🧪 测试 3: URL 稳定性

验证 URL 缓存和复用机制

#### 步骤

1. 分析 Instagram iOS（第一次）
2. 记录 URL：`/analysis/instagram-ios`
3. 再次分析 Instagram iOS（第二次）
4. 对比 URL

#### 预期结果

- ✅ 两次 URL 完全相同
- ✅ 第二次立即返回（显示缓存）
- ✅ 数据自动复用（24小时内）

---

## 常见问题

### Q1: npm install 失败，显示 "network error"

**原因：** npm 默认源在中国访问慢或超时

**解决：**
```bash
# 切换到国内镜像
npm config set registry https://registry.npmmirror.com
npm cache clean --force
npm install
```

---

### Q2: 数据库连接失败 (P1000: Authentication failed)

**原因：** 密码包含特殊字符导致 URL 编码问题

**解决：**
1. 去 Supabase → Settings → Database
2. Reset password，使用**纯字母数字**（如 `Liu184205909`）
3. 更新 `.env.local` 中的 `DATABASE_URL`

---

### Q3: Prisma 报错 "Schema engine error"

**原因：** 使用了 Transaction mode（不兼容 Prisma）

**解决：**
1. Supabase → Settings → Database → Connection string
2. 选择 **Session mode**
3. 复制包含 `?pgbouncer=true` 的连接串
4. 更新 `.env.local`

---

### Q4: 启动服务器后浏览器无法访问

**检查步骤：**

```bash
# 1. 确认服务器正在运行
# 终端应该显示：
# ✓ Ready in 3.2s

# 2. 检查端口是否被占用
netstat -ano | findstr :3000  # Windows
lsof -i :3000                 # Mac/Linux

# 3. 尝试重启服务器
# Ctrl+C 停止，然后：
npm run dev

# 4. 清除缓存重启
rm -rf .next  # Mac/Linux
Remove-Item -Recurse -Force .next  # Windows
npm run dev
```

---

### Q5: AI 分析失败或没有结果

**检查：**

```bash
# 1. 确认 OpenRouter API Key 正确
# 打开 .env.local 检查 OPENROUTER_API_KEY

# 2. 检查账户余额
# 访问 https://openrouter.ai → Settings → Credits

# 3. 查看终端错误日志
# 应该显示具体的错误信息
```

---

### Q6: 重复分析同一应用，生成了不同的 URL

**原因：** 数据库中 `appSlug` 重复

**解决：**
```bash
# 重新推送数据库 schema
npx prisma db push --force-reset

# 重新生成 Prisma Client
npx prisma generate

# 重启服务器
npm run dev
```

---

## Google Play 访问问题

### 问题现象

测试 Android 应用时出现 `Error: App not found`

### 根本原因

**Google Play 在中国大陆被封锁**，`google-play-scraper` 无法访问。

### 解决方案

#### 方案 1: 使用 SerpApi ⭐（推荐）

**优势：**
- ✅ 稳定可靠（不受网络限制）
- ✅ 免费额度：100 次/月
- ✅ 5 分钟集成

**步骤：**

1. **注册 SerpApi**
   - 访问 https://serpapi.com/users/sign_up
   - 使用 GitHub 或 Google 登录
   - 免费（100 次搜索/月）

2. **获取 API Key**
   - 登录后访问 https://serpapi.com/manage-api-key
   - 复制 API Key

3. **配置环境变量**
   ```bash
   # 编辑 .env.local，添加：
   SERPAPI_KEY="你的_SerpApi_Key"
   ```

4. **安装 SDK**
   ```bash
   npm install serpapi
   ```

5. **集成代码**（我已经准备好，需要的话告诉我）

**成本估算：**
- 免费：100 次/月
- 付费：$50/月（5000 次）

---

#### 方案 2: 配置 HTTP 代理

如果你有 **VPN 或代理服务器**：

```bash
# 设置环境变量（临时）
$env:HTTP_PROXY="http://127.0.0.1:7890"   # Windows
$env:HTTPS_PROXY="http://127.0.0.1:7890"

# 启动服务器
npm run dev
```

**注意：** `google-play-scraper` 默认不支持代理，可能需要使用 `global-agent`。

---

#### 方案 3: 部署到 Vercel ⭐⭐⭐（生产环境最佳）

**Vercel 服务器在海外，自动解决网络问题**

```bash
# 1. 推送到 GitHub
git init
git add .
git commit -m "Initial commit"
git remote add origin <your-github-repo>
git push -u origin main

# 2. 部署到 Vercel
# 访问 https://vercel.com/new
# → Import from GitHub
# → 选择你的仓库
# → 配置环境变量（DATABASE_URL, OPENROUTER_API_KEY）
# → Deploy
```

**优势：**
- ✅ 完全免费
- ✅ 自动 HTTPS
- ✅ 全球 CDN
- ✅ 无网络限制

---

### 当前建议

1. **测试阶段：** 先跳过 Android，只测试 iOS
2. **快速验证：** 注册 SerpApi（5分钟，免费100次）
3. **生产环境：** 部署到 Vercel（20分钟，完全免费）

---

## 部署到生产环境

### 使用 Vercel（推荐）

#### 步骤 1: 准备代码

```bash
# 确保所有更改已提交
git add .
git commit -m "Ready for deployment"
git push
```

#### 步骤 2: 连接 Vercel

1. 访问 https://vercel.com
2. 使用 GitHub 登录
3. 点击 "Add New Project"
4. 选择你的 GitHub 仓库

#### 步骤 3: 配置环境变量

在 Vercel 项目设置中添加：

```
DATABASE_URL=你的_Supabase_连接串
OPENROUTER_API_KEY=你的_OpenRouter_Key
SERPAPI_KEY=你的_SerpApi_Key（如果使用）
```

#### 步骤 4: 部署

- 点击 "Deploy"
- 等待 2-3 分钟
- 获得生产 URL：`https://your-project.vercel.app`

#### 步骤 5: 测试生产环境

访问你的 Vercel URL，测试所有功能（包括 Android）

---

## 📚 其他文档

- **[README.md](./README.md)** - 项目介绍和快速开始
- **[技术说明.md](./技术说明.md)** - 技术架构和设计细节
- **[PROJECT_STRUCTURE.md](./PROJECT_STRUCTURE.md)** - 项目结构

---

## 🎯 开发流程建议

### 第一次使用（新手）

1. ✅ 按照本文档完成环境配置
2. ✅ 测试 Instagram iOS（验证功能）
3. ✅ 阅读 [技术说明.md](./技术说明.md)（了解原理）
4. ✅ 部署到 Vercel（测试生产环境）

### 日常开发

1. 启动服务器：`npm run dev`
2. 修改代码（自动热重载）
3. 测试功能
4. 提交代码：`git add . && git commit -m "description"`
5. 推送：`git push`（Vercel 自动部署）

---

## 💬 需要帮助？

- **遇到错误：** 查看上面的 [常见问题](#常见问题)
- **功能疑问：** 查看 [README.md](./README.md) 或 [技术说明.md](./技术说明.md)
- **代码问题：** 查看 [PROJECT_STRUCTURE.md](./PROJECT_STRUCTURE.md)

**祝你开发顺利！** 🚀

