# 📦 App Review Analyzer - 部署与配置指南

> 完整的部署和配置文档，涵盖 Vercel 部署、数据库设置、功能开关等

---

## 📋 目录

1. [快速开始](#快速开始)
2. [Vercel 部署](#vercel-部署)
3. [数据库配置](#数据库配置)
4. [功能开关配置](#功能开关配置)
5. [访客试用功能](#访客试用功能)
6. [常见问题](#常见问题)

---

## 🚀 快速开始

### 环境要求

- Node.js 18+
- PostgreSQL 14+ 数据库
- Vercel 账号（免费）

### 必需的环境变量

```env
# 数据库连接
DATABASE_URL="postgresql://user:password@host:5432/dbname"

# JWT 认证
JWT_SECRET="your-super-secret-jwt-key-at-least-32-characters-long"

# AI 分析服务
OPENROUTER_API_KEY="sk-or-v1-your-api-key"

# 应用 URL
NEXT_PUBLIC_APP_URL="https://your-app.vercel.app"
```

---

## 🌐 Vercel 部署

### 方法 1：通过 Vercel Dashboard（推荐）

1. **登录 Vercel**
   - 访问 [vercel.com](https://vercel.com)
   - 使用 GitHub 账号登录

2. **导入项目**
   - 点击 `Add New...` → `Project`
   - 选择你的 GitHub 仓库
   - 点击 `Import`

3. **配置环境变量**
   
   在 `Environment Variables` 部分添加以下变量：

   **必需变量** ⚠️
   ```bash
   # 数据库连接
   DATABASE_URL=postgresql://user:password@host:5432/dbname
   
   # JWT 密钥（生成一个随机字符串）
   JWT_SECRET=your-super-secret-jwt-key-at-least-32-characters-long
   
   # AI 服务
   OPENROUTER_API_KEY=sk-or-v1-your-api-key
   
   # 应用 URL
   NEXT_PUBLIC_APP_URL=https://your-app-name.vercel.app
   ```

   **可选变量**（根据需要配置）
   ```bash
   # 邮件服务（用于通知）
   SMTP_HOST=smtp.gmail.com
   SMTP_PORT=587
   SMTP_USER=your-email@gmail.com
   SMTP_PASS=your-app-password
   
   # OAuth 登录（参见 OAUTH_SETUP.md）
   GOOGLE_CLIENT_ID=your-google-client-id
   GOOGLE_CLIENT_SECRET=your-google-client-secret
   
   # Stripe 支付（如需订阅功能，参见功能开关配置）
   ENABLE_SUBSCRIPTIONS=false
   STRIPE_SECRET_KEY=sk_test_your_stripe_key
   STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret
   ```

4. **部署**
   - 点击 `Deploy`
   - 等待构建完成（约 2-5 分钟）

### 方法 2：通过 Vercel CLI

```bash
# 安装 Vercel CLI
npm install -g vercel

# 登录
vercel login

# 部署
vercel

# 部署到生产环境
vercel --prod
```

---

## 🗄️ 数据库配置

### 选项 A：使用 Supabase（推荐，免费）

1. 访问 [supabase.com](https://supabase.com) 并创建账号
2. 创建新项目
3. 等待数据库初始化完成
4. 进入 `Settings` → `Database`
5. 找到 `Connection String` → `URI`
6. 复制连接字符串：
   ```
   postgresql://postgres:[PASSWORD]@db.[PROJECT].supabase.co:5432/postgres
   ```
7. 在 Vercel 环境变量中设置 `DATABASE_URL`

### 选项 B：使用 Neon

1. 访问 [neon.tech](https://neon.tech) 并创建账号
2. 创建新项目
3. 复制 `Connection String`
4. 在 Vercel 环境变量中设置 `DATABASE_URL`

### 初始化数据库

部署成功后，初始化数据库：

```bash
# 方法 1：使用 Vercel CLI
vercel link
vercel env pull .env.local
npx prisma db push

# 方法 2：首次部署时在 Vercel 设置构建命令
# Build Command: prisma generate && prisma db push --accept-data-loss && next build
# ⚠️ 只在首次部署时使用，之后改回默认
```

### 验证数据库连接

```bash
# 测试数据库连接
curl https://your-app.vercel.app/api/health
```

---

## ⚙️ 功能开关配置

本应用支持通过环境变量开关部分功能，无需修改代码。

### 订阅功能开关

**默认状态：禁用**

如果你暂时不想配置 Stripe 支付，可以禁用订阅功能：

```env
# 禁用订阅功能（默认）
ENABLE_SUBSCRIPTIONS="false"
NEXT_PUBLIC_ENABLE_SUBSCRIPTIONS="false"
```

**功能影响：**
- ✅ 用户仍可注册和登录
- ✅ 免费用户可使用（每月 3 次分析）
- ❌ 无法购买 Professional/Team 订阅
- ❌ 定价页面显示"功能暂未启用"提示
- ❌ Dashboard 不显示"升级"按钮

### 启用订阅功能

如需启用付费订阅：

1. **注册 Stripe 账号**
   - 访问 [stripe.com](https://stripe.com)
   - 创建账号并获取 API 密钥

2. **配置环境变量**
   ```env
   # 启用订阅功能
   ENABLE_SUBSCRIPTIONS="true"
   NEXT_PUBLIC_ENABLE_SUBSCRIPTIONS="true"
   
   # Stripe 配置
   STRIPE_SECRET_KEY="sk_live_..."
   STRIPE_WEBHOOK_SECRET="whsec_..."
   STRIPE_PRICE_PRO_MONTHLY="price_xxx"
   STRIPE_PRICE_PRO_YEARLY="price_xxx"
   STRIPE_PRICE_TEAM_MONTHLY="price_xxx"
   STRIPE_PRICE_TEAM_YEARLY="price_xxx"
   ```

3. **配置 Stripe Webhook**
   - Webhook URL: `https://your-app.vercel.app/api/stripe/webhook`
   - 监听事件: `checkout.session.completed`, `customer.subscription.updated`, `customer.subscription.deleted`

4. **重新部署应用**

---

## 🎯 访客试用功能

### 功能说明

允许未登录用户免费试用分析功能（无需注册）。

| 用户类型 | 分析次数 | 查看结果 | 保存历史 |
|---------|---------|---------|---------|
| **访客** | 1 次（24小时后重置） | ✅ | ❌ |
| **Free 用户** | 每月 3 次 | ✅ | ✅ |
| **Pro 用户** | 无限 | ✅ | ✅ |

### 数据库迁移

访客功能需要数据库支持，首次部署后运行：

```bash
# 本地开发环境
npx prisma migrate dev --name add_guest_analysis

# 生产环境（Vercel）
npx prisma migrate deploy
```

### 工作原理

- **访客识别**：基于 IP 地址 + 浏览器指纹
- **限制策略**：24 小时内只能分析 1 次
- **数据清理**：访客记录自动过期（可设置定时任务清理）

### 用户体验流程

```
1. 访客访问首页
   ↓
2. 输入 App URL，点击"开始分析"
   ↓
3. 查看完整的分析结果
   ↓
4. [3秒后] 弹出注册提示
   "喜欢这个工具吗？注册以保存历史记录！"
   ↓
5. 24小时后可再次使用
```

### 可选：配置定时清理任务

创建 `vercel.json`：

```json
{
  "crons": [{
    "path": "/api/cron/cleanup-guests",
    "schedule": "0 0 * * *"
  }]
}
```

---

## 🐛 常见问题排查

### 问题 1: "Failed to collect page data"

**原因**: 构建时数据库未配置或连接失败

**解决方案**: 
- ✅ 已修复：API 路由已添加错误处理
- 确保 `DATABASE_URL` 环境变量已正确配置
- 在 Vercel Dashboard 中检查构建日志

### 问题 2: "Prisma Client initialization error"

**原因**: Prisma 未生成客户端

**解决方案**:
- 确保 `package.json` 中包含 `@prisma/client`
- Vercel 会自动运行 `prisma generate`
- 触发重新部署

### 问题 3: 数据库连接超时

**原因**: 
- 数据库 URL 错误
- 数据库防火墙阻止 Vercel IP

**解决方案**:
- 检查数据库 URL 格式
- Supabase: 默认允许所有连接
- Neon: 在 `Settings` 中启用 `Allow all IPs`

### 问题 4: 环境变量未生效

**原因**: 环境变量配置后需要重新部署

**解决方案**:
1. 修改环境变量后
2. 进入 `Deployments` → 点击 `...` → `Redeploy`
3. ✅ 勾选 `Use existing Build Cache` 可加快速度

### 问题 5: Stripe 支付功能不可用

**原因**: Stripe 环境变量未配置或订阅功能未启用

**解决方案**:
- 检查 `ENABLE_SUBSCRIPTIONS` 是否设为 `true`
- 确认所有 Stripe 环境变量已配置
- 验证 Webhook 配置是否正确

---

## 🔒 安全建议

### 1. 强密码生成

```bash
# 生成 JWT_SECRET
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 2. 环境变量管理

- ✅ 使用 Vercel 环境变量存储敏感信息
- ✅ 生产环境使用生产密钥
- ✅ 预览环境使用测试密钥
- ❌ 永远不要将密钥提交到代码仓库

### 3. HTTPS 强制

- Vercel 默认启用 HTTPS，无需配置

### 4. 配置域名

- 在 Vercel Dashboard → `Settings` → `Domains`
- 添加自定义域名以提升专业度

---

## 📊 监控和日志

### 查看实时日志

```bash
# 使用 Vercel CLI
vercel logs your-app-name --follow
```

### Vercel Dashboard 监控

1. **实时日志**
   - 进入 `Deployments`
   - 点击部署 → `Runtime Logs`

2. **性能监控**
   - `Analytics` - 页面访问量
   - `Speed Insights` - 性能指标
   - `Web Vitals` - 用户体验指标

---

## 🔄 更新部署

### 自动部署（推荐）

- 推送到 `main` 分支会自动触发生产部署
- 推送到其他分支会创建预览部署

### 手动部署

```bash
# 部署到生产环境
vercel --prod

# 创建预览部署
vercel
```

---

## ✅ 部署后验证清单

- [ ] 访问应用首页，确认正常显示
- [ ] 测试用户注册和登录
- [ ] 测试应用分析功能
- [ ] 测试访客试用功能
- [ ] 检查 `/api/health` 端点
- [ ] 验证邮件通知（如已配置）
- [ ] 测试 OAuth 登录（如已配置）
- [ ] 测试支付功能（如已启用）

---

## 🎯 推荐配置

### 最小配置（快速上线）

```env
DATABASE_URL="postgresql://..."
JWT_SECRET="random-secret-key"
OPENROUTER_API_KEY="sk-or-v1-..."
NEXT_PUBLIC_APP_URL="https://your-app.vercel.app"
```

### 完整配置（所有功能）

```env
# 核心配置
DATABASE_URL="postgresql://..."
JWT_SECRET="random-secret-key"
OPENROUTER_API_KEY="sk-or-v1-..."
NEXT_PUBLIC_APP_URL="https://your-app.vercel.app"

# OAuth 登录
GOOGLE_CLIENT_ID="xxx.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="GOCSPX-xxx"

# 邮件通知
SMTP_HOST="smtp.gmail.com"
SMTP_PORT="587"
SMTP_USER="your-email@gmail.com"
SMTP_PASS="your-app-password"

# 订阅功能
ENABLE_SUBSCRIPTIONS="true"
NEXT_PUBLIC_ENABLE_SUBSCRIPTIONS="true"
STRIPE_SECRET_KEY="sk_live_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
```

---

## 📚 相关文档

- [OAuth 配置指南](./OAUTH_SETUP.md) - Google 和 Apple 登录配置
- [开发指南](./docs/开发指南.md) - 完整的开发文档
- [README](./README.md) - 项目介绍和快速开始

---

## 🆘 需要帮助？

- 📖 [Next.js 文档](https://nextjs.org/docs)
- 📖 [Vercel 文档](https://vercel.com/docs)
- 📖 [Prisma 文档](https://www.prisma.io/docs)
- 📖 [Stripe 文档](https://stripe.com/docs)

---

**祝部署顺利！🎉**

部署完成后，记得测试所有功能并监控应用性能。

